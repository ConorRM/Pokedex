<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>151: Collector V3.5</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1068/1068780.png" type="image/png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1068/1068780.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; touch-action: pan-y; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .card-hover:hover { transform: translateY(-5px); transition: transform 0.2s; }
        
        /* --- RARITY STYLES --- */
        .rarity-mega { border-color: #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .badge-mega { background: linear-gradient(135deg, #6b21a8, #a855f7); color: white; }

        .rarity-ex { border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .badge-ex { background: linear-gradient(135deg, #047857, #10b981); color: white; }

        .rarity-gx { border-color: #06b6d4; box-shadow: 0 0 15px rgba(6, 182, 212, 0.4); }
        .badge-gx { background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; }

        .rarity-v { border-color: #94a3b8; box-shadow: 0 0 15px rgba(148, 163, 184, 0.4); }
        .badge-v { background: linear-gradient(135deg, #334155, #94a3b8); color: white; }

        .rarity-vmax { border-color: #f43f5e; box-shadow: 0 0 15px rgba(244, 63, 94, 0.5); }
        .badge-vmax { background: linear-gradient(135deg, #be123c, #f43f5e); color: white; }

        .rarity-vstar { border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.5); }
        .badge-vstar { background: linear-gradient(135deg, #a16207, #eab308); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        
        .extra-border { border-style: dashed; border-color: #3b82f6; }
        .add-card-border { border-style: dashed; border-color: #4ade80; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        .glass-input {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.5);
            backdrop-filter: blur(4px);
            font-size: 16px; 
        }
        .glass-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.9);
        }
        
        select.glass-input option {
            background-color: #1e293b;
            color: white;
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-zoom {
            animation: zoomIn 0.2s ease-out forwards;
        }

        .dex-scrubber { touch-action: none; }
        
        .fan-art-badge {
            background: linear-gradient(135deg, #ec4899, #db2777);
            animation: pulse-border 2s infinite;
        }

        .dream-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            animation: pulse-border 3s infinite;
        }

        .ideal-badge {
            background: linear-gradient(135deg, #06b6d4, #0ea5e9);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
            animation: pulse-border 4s infinite;
        }
        
        .stats-gradient {
            background: linear-gradient(90deg, rgba(15,23,42,0) 0%, rgba(51,65,85,0.5) 50%, rgba(15,23,42,0) 100%);
        }

        .trainer-separator {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 1.5rem 0 0.5rem 0;
        }
        .trainer-separator::after {
            content: "";
            flex: 1;
            height: 1px;
            background: repeating-linear-gradient(90deg, #475569 0, #475569 6px, transparent 6px, transparent 12px);
        }

        /* NEW STYLES FOR TRAINER BREAKS */
        .trainer-break {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
        }
        .trainer-break::before {
            content: "";
            width: 100%;
            height: 1px;
            background: repeating-linear-gradient(90deg, #6366f1 0, #6366f1 4px, transparent 4px, transparent 12px); 
        }
        .trainer-break-top {
            margin: 1rem 0 1.5rem 0;
        }
        .trainer-break-bottom {
            margin: 1.5rem 0 1rem 0;
        }
    </style>
</head>
<body>


<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useMemo, useRef } = React;

    // --- ICONS ---
    const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
    const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
    const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
    const IconTarget = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
    const IconDna = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h5"></path><path d="M17 12h5"></path><path d="M9 12a3 3 0 1 0 6 0"></path><path d="M14.5 2.5a6 6 0 1 0-5 19"></path><path d="M9.5 2.5a6 6 0 1 1 5 19"></path></svg>;
    const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2-2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
    const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2-2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
    const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
    const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
    const IconImage = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>;
    const IconDollar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
    const IconZoom = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>;
    const IconMaximize = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path><path d="M21 3l-7 7"></path><path d="M3 21l7-7"></path></svg>;
    const IconMinimize = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14h6v6"></path><path d="M20 10h-6V4"></path><path d="M14 10l7-7"></path><path d="M3 21l7-7"></path></svg>;
    const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;
    const IconArrowUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>;
    const IconArrowDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>;
    const IconPalette = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>;
    const IconStar = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
    const IconSparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>;
    const IconClipboard = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>;
    const IconExchange = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10h14l-4-4"/><path d="M17 14H3l4 4"/></svg>;
    const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
    const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>;
    const IconPound = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 7c0-5.333-8-5.333-8 0v14h10"/><path d="M6 13h9"/></svg>;
    const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
    const IconGraph = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>;
    const IconCards = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>;

    // --- UTILS ---
    const Toast = ({ msg, onClose }) => {
        useEffect(() => {
            const timer = setTimeout(onClose, 3000);
            return () => clearTimeout(timer);
        }, [msg]);
        if (!msg) return null;
        return (
            <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-indigo-500 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] animate-bounce flex items-center gap-2">
                <IconCheck />
                <span className="font-semibold">{msg}</span>
            </div>
        );
    };

    const ConfirmDialog = ({ config, onCancel }) => {
        if (!config) return null;
        return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
                <div className="bg-slate-800 rounded-xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl transform transition-all scale-100">
                    <h3 className="text-xl font-bold mb-3 text-white">Confirm Action</h3>
                    <p className="text-slate-300 mb-6">{config.msg}</p>
                    <div className="flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">Cancel</button>
                        <button onClick={() => { config.action(); onCancel(); }} className="px-5 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-bold text-white shadow-lg transition-transform active:scale-95">Confirm</button>
                    </div>
                </div>
            </div>
        );
    };

    const parseCSVRow = (str) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < str.length; i++) {
            const char = str[i];
            if (char === '"') {
                if (inQuotes && str[i + 1] === '"') { current += '"'; i++; } 
                else { inQuotes = !inQuotes; }
            } else if (char === ',' && !inQuotes) { result.push(current); current = ''; } 
            else { current += char; }
        }
        result.push(current);
        return result;
    };

    const ImagePreviewModal = ({ src, onClose }) => {
        const [fillMode, setFillMode] = useState(false);
        useEffect(() => {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
            return () => { if (viewport) viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'); };
        }, []);
        if (!src) return null;
        return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black" onClick={onClose}>
                <div className="absolute top-4 right-4 flex gap-4 z-50">
                    <button onClick={(e) => { e.stopPropagation(); setFillMode(!fillMode); }} className="text-white hover:text-indigo-400 bg-slate-800/80 p-3 rounded-full backdrop-blur transition-colors">
                        {fillMode ? <IconMinimize /> : <IconMaximize />}
                    </button>
                    <button onClick={onClose} className="text-white hover:text-red-400 bg-slate-800/80 p-3 rounded-full backdrop-blur transition-colors">
                        <IconX />
                    </button>
                </div>
                <img src={src} className={`transition-all duration-300 animate-zoom ${fillMode ? "w-full h-full object-cover" : "max-w-full max-h-full object-contain p-1"}`} onClick={(e) => e.stopPropagation()} />
            </div>
        );
    };

    // --- BASE DATA ---
    const RAW_POKEMON = [
        { name: "Bulbasaur", cardImage: "https://images.pokemontcg.io/sv3pt5/166_hires.png" },
        { name: "Ivysaur", cardImage: "https://images.pokemontcg.io/sv3pt5/167_hires.png" },
        { name: "Venusaur", cardImage: "https://images.pokemontcg.io/sv3pt5/198_hires.png" },
        { name: "Charmander", cardImage: "https://images.pokemontcg.io/sv3pt5/168_hires.png" },
        { name: "Charmeleon", cardImage: "https://images.pokemontcg.io/sv3pt5/169_hires.png" },
        { name: "Charizard", cardImage: "https://images.pokemontcg.io/sv3pt5/199_hires.png" },
        { name: "Squirtle", cardImage: "https://images.pokemontcg.io/sv3pt5/170_hires.png" },
        { name: "Wartortle", cardImage: "https://images.pokemontcg.io/sv3pt5/171_hires.png" },
        { name: "Blastoise", cardImage: "https://images.pokemontcg.io/sv3pt5/200_hires.png" },
        { name: "Caterpie", cardImage: "https://images.pokemontcg.io/sv3pt5/172_hires.png" },
        "Metapod", "Butterfree", "Weedle", "Kakuna", 
        { name: "Beedrill", cardImage: "https://images.pokemontcg.io/swsh10/V_hires.png" },
        "Pidgey", "Pidgeotto", "Pidgeot", "Rattata", "Raticate", "Spearow", "Fearow", "Ekans", "Arbok", 
        { name: "Pikachu", cardImage: "https://images.pokemontcg.io/sv3pt5/173_hires.png" },
        { name: "Raichu", cardImage: "https://images.pokemontcg.io/sv2/211_hires.png" },
        "Sandshrew", "Sandslash", "Nidoran♀", "Nidorina", "Nidoqueen", "Nidoran♂", "Nidorino", 
        { name: "Nidoking", cardImage: "https://images.pokemontcg.io/sv3pt5/174_hires.png" },
        "Clefairy", "Clefable", "Vulpix", 
        { name: "Ninetales", cardImage: "https://images.pokemontcg.io/sv3pt5/186_hires.png" },
        "Jigglypuff", "Wigglytuff", "Zubat", "Golbat", "Oddish", "Gloom", "Vileplume", "Paras", "Parasect", "Venonat", "Venomoth", "Diglett", "Dugtrio", "Meowth", "Persian", 
        { name: "Psyduck", cardImage: "https://images.pokemontcg.io/sv3pt5/175_hires.png" },
        "Golduck", "Mankey", "Primeape", 
        { name: "Growlithe", cardImage: "https://images.pokemontcg.io/swsh8/TG01_hires.png" },
        { name: "Arcanine", cardImage: "https://images.pokemontcg.io/sv1/224_hires.png" },
        "Poliwag", { name: "Poliwhirl", cardImage: "https://images.pokemontcg.io/sv3pt5/176_hires.png" },
        "Poliwrath", "Abra", "Kadabra", 
        { name: "Alakazam", cardImage: "https://images.pokemontcg.io/sv3pt5/201_hires.png" },
        "Machop", { name: "Machoke", cardImage: "https://images.pokemontcg.io/sv3pt5/177_hires.png" },
        { name: "Machamp", cardImage: "https://images.pokemontcg.io/swsh10/V_hires.png" },
        "Bellsprout", "Weepinbell", "Victreebel", "Tentacool", "Tentacruel", "Geodude", "Graveler", "Golem", "Ponyta", 
        { name: "Rapidash", cardImage: "https://images.pokemontcg.io/swsh12/TG11_hires.png" },
        "Slowpoke", "Slowbro", "Magnemite", "Magneton", "Farfetch’d", "Doduo", "Dodrio", "Seel", "Dewgong", "Grimer", "Muk", "Shellder", "Cloyster", "Gastly", "Haunter", 
        { name: "Gengar", cardImage: "https://images.pokemontcg.io/swsh8/271_hires.png" },
        "Onix", "Drowzee", "Hypno", "Krabby", "Kingler", "Voltorb", "Electrode", "Exeggcute", "Exeggutor", "Cubone", "Marowak", "Hitmonlee", "Hitmonchan", "Lickitung", "Koffing", "Weezing", "Rhyhorn", "Rhydon", "Chansey", 
        { name: "Tangela", cardImage: "https://images.pokemontcg.io/sv3pt5/178_hires.png" },
        "Kangaskhan", "Horsea", "Seadra", "Goldeen", "Seaking", "Staryu",
        { name: "Starmie", cardImage: "https://images.pokemontcg.io/swsh10/TG13_hires.png" },
        { name: "Mr. Mime", cardImage: "https://images.pokemontcg.io/sv3pt5/179_hires.png" },
        "Scyther", { name: "Jynx", cardImage: "https://images.pokemontcg.io/sv3pt5/191_hires.png" },
        "Electabuzz", "Magmar", "Pinsir", "Tauros", 
        { name: "Magikarp", cardImage: "https://images.pokemontcg.io/sv2/203_hires.png" },
        { name: "Gyarados", cardImage: "https://images.pokemontcg.io/xy9/123_hires.png" },
        { name: "Lapras", cardImage: "https://images.pokemontcg.io/swsh12pt5/GG05_hires.png" },
        { name: "Ditto", cardImage: "https://images.pokemontcg.io/swsh12pt5/GG22_hires.png" },
        { name: "Eevee", cardImage: "https://images.pokemontcg.io/swsh9/TG11_hires.png" },
        { name: "Vaporeon", cardImage: "https://images.pokemontcg.io/swsh9/TG02_hires.png" },
        { name: "Jolteon", cardImage: "https://images.pokemontcg.io/swsh9/TG04_hires.png" },
        { name: "Flareon", cardImage: "https://images.pokemontcg.io/swsh9/TG01_hires.png" },
        "Porygon", { name: "Omanyte", cardImage: "https://images.pokemontcg.io/sv3pt5/180_hires.png" },
        "Omastar", "Kabuto", "Kabutops", 
        { name: "Aerodactyl", cardImage: "https://images.pokemontcg.io/swsh11/180_hires.png" },
        { name: "Snorlax", cardImage: "https://images.pokemontcg.io/swsh11/TG10_hires.png" },
        { name: "Articuno", cardImage: "https://images.pokemontcg.io/swsh6/169_hires.png" },
        { name: "Zapdos", cardImage: "https://images.pokemontcg.io/sv3pt5/202_hires.png" },
        { name: "Moltres", cardImage: "https://images.pokemontcg.io/swsh6/176_hires.png" },
        "Dratini", { name: "Dragonair", cardImage: "https://images.pokemontcg.io/sv3pt5/181_hires.png" },
        { name: "Dragonite", cardImage: "https://images.pokemontcg.io/swsh7/192_hires.png" },
        { name: "Mewtwo", cardImage: "https://images.pokemontcg.io/swsh12pt5/GG44_hires.png" },
        { name: "Mew", cardImage: "https://images.pokemontcg.io/sv3pt5/151_hires.png" }
    ];

    const GEN_2_POKEMON = [
        { id: 152, name: "Chikorita" }, { id: 153, name: "Bayleef" }, { id: 154, name: "Meganium" }, { id: 155, name: "Cyndaquil" }, { id: 156, name: "Quilava" }, { id: 157, name: "Typhlosion" }, { id: 158, name: "Totodile" }, { id: 159, name: "Croconaw" }, { id: 160, name: "Feraligatr" },
        { id: 161, name: "Sentret" }, { id: 162, name: "Furret" }, { id: 163, name: "Hoothoot" }, { id: 164, name: "Noctowl" }, { id: 165, name: "Ledyba" }, { id: 166, name: "Ledian" }, { id: 167, name: "Spinarak" }, { id: 168, name: "Ariados" }, { id: 169, name: "Crobat" }, { id: 170, name: "Chinchou" }, { id: 171, name: "Lanturn" },
        { id: 172, name: "Pichu" }, { id: 173, name: "Cleffa" }, { id: 174, name: "Igglybuff" }, { id: 175, name: "Togepi" }, { id: 176, name: "Togetic" }, { id: 177, name: "Natu" }, { id: 178, name: "Xatu" }, { id: 179, name: "Mareep" }, { id: 180, name: "Flaaffy" }, { id: 181, name: "Ampharos" }, { id: 182, name: "Bellossom" },
        { id: 183, name: "Marill" }, { id: 184, name: "Azumarill" }, { id: 185, name: "Sudowoodo" }, { id: 186, name: "Politoed" }, { id: 187, name: "Hoppip" }, { id: 188, name: "Skiploom" }, { id: 189, name: "Jumpluff" }, { id: 190, name: "Aipom" }, { id: 191, name: "Sunkern" }, { id: 192, name: "Sunflora" },
        { id: 193, name: "Yanma" }, { id: 194, name: "Wooper" }, { id: 195, name: "Quagsire" }, { id: 196, name: "Espeon" }, { id: 197, name: "Umbreon" }, { id: 198, name: "Murkrow" }, { id: 199, name: "Slowking" }, { id: 200, name: "Misdreavus" }, { id: 201, name: "Unown" }, { id: 202, name: "Wobbuffet" },
        { id: 203, name: "Girafarig" }, { id: 204, name: "Pineco" }, { id: 205, name: "Forretress" }, { id: 206, name: "Dunsparce" }, { id: 207, name: "Gligar" }, { id: 208, name: "Steelix" }, { id: 209, name: "Snubbull" }, { id: 210, name: "Granbull" }, { id: 211, name: "Qwilfish" }, { id: 212, name: "Scizor" },
        { id: 213, name: "Shuckle" }, { id: 214, name: "Heracross" }, { id: 215, name: "Sneasel" }, { id: 216, name: "Teddiursa" }, { id: 217, name: "Ursaring" }, { id: 218, name: "Slugma" }, { id: 219, name: "Magcargo" }, { id: 220, name: "Swinub" }, { id: 221, name: "Piloswine" }, { id: 222, name: "Corsola" },
        { id: 223, name: "Remoraid" }, { id: 224, name: "Octillery" }, { id: 225, name: "Delibird" }, { id: 226, name: "Mantine" }, { id: 227, name: "Skarmory" }, { id: 228, name: "Houndour" }, { id: 229, name: "Houndoom" }, { id: 230, name: "Kingdra" }, { id: 231, name: "Phanpy" }, { id: 232, name: "Donphan" },
        { id: 233, name: "Porygon2" }, { id: 234, name: "Stantler" }, { id: 235, name: "Smeargle" }, { id: 236, name: "Tyrogue" }, { id: 237, name: "Hitmontop" }, { id: 238, name: "Smoochum" }, { id: 239, name: "Elekid" }, { id: 240, name: "Magby" }, { id: 241, name: "Miltank" }, { id: 242, name: "Blissey" },
        { id: 243, name: "Raikou" }, { id: 244, name: "Entei" }, { id: 245, name: "Suicune" }, { id: 246, name: "Larvitar" }, { id: 247, name: "Pupitar" }, { id: 248, name: "Tyranitar" }, { id: 249, name: "Lugia" }, { id: 250, name: "Ho-Oh" }, { id: 251, name: "Celebi" }
    ];

    const GEN_3_POKEMON = [
        { id: 252, name: "Treecko" }, { id: 253, name: "Grovyle" }, { id: 254, name: "Sceptile" }, { id: 255, name: "Torchic" }, { id: 256, name: "Combusken" }, { id: 257, name: "Blaziken" }, { id: 258, name: "Mudkip" }, { id: 259, name: "Marshtomp" }, { id: 260, name: "Swampert" },
        { id: 261, name: "Poochyena" }, { id: 262, name: "Mightyena" }, { id: 263, name: "Zigzagoon" }, { id: 264, name: "Linoone" }, { id: 265, name: "Wurmple" }, { id: 266, name: "Silcoon" }, { id: 267, name: "Beautifly" }, { id: 268, name: "Cascoon" }, { id: 269, name: "Dustox" },
        { id: 270, name: "Lotad" }, { id: 271, name: "Lombre" }, { id: 272, name: "Ludicolo" }, { id: 273, name: "Seedot" }, { id: 274, name: "Nuzleaf" }, { id: 275, name: "Shiftry" }, { id: 276, name: "Taillow" }, { id: 277, name: "Swellow" }, { id: 278, name: "Wingull" }, { id: 279, name: "Pelipper" },
        { id: 280, name: "Ralts" }, { id: 281, name: "Kirlia" }, { id: 282, name: "Gardevoir" }, { id: 283, name: "Surskit" }, { id: 284, name: "Masquerain" }, { id: 285, name: "Shroomish" }, { id: 286, name: "Breloom" }, { id: 287, name: "Slakoth" }, { id: 288, name: "Vigoroth" }, { id: 289, name: "Slaking" },
        { id: 290, name: "Nincada" }, { id: 291, name: "Ninjask" }, { id: 292, name: "Shedinja" }, { id: 293, name: "Whismur" }, { id: 294, name: "Loudred" }, { id: 295, name: "Exploud" }, { id: 296, name: "Makuhita" }, { id: 297, name: "Hariyama" }, { id: 298, name: "Azurill" }, { id: 299, name: "Nosepass" },
        { id: 300, name: "Skitty" }, { id: 301, name: "Delcatty" }, { id: 302, name: "Sableye" }, { id: 303, name: "Mawile" }, { id: 304, name: "Aron" }, { id: 305, name: "Lairon" }, { id: 306, name: "Aggron" }, { id: 307, name: "Meditite" }, { id: 308, name: "Medicham" }, { id: 309, name: "Electrike" }, { id: 310, name: "Manectric" },
        { id: 311, name: "Plusle" }, { id: 312, name: "Minun" }, { id: 313, name: "Volbeat" }, { id: 314, name: "Illumise" }, { id: 315, name: "Roselia" }, { id: 316, name: "Gulpin" }, { id: 317, name: "Swalot" }, { id: 318, name: "Carvanha" }, { id: 319, name: "Sharpedo" },
        { id: 320, name: "Wailmer" }, { id: 321, name: "Wailord" }, { id: 322, name: "Numel" }, { id: 323, name: "Camerupt" }, { id: 324, name: "Torkoal" }, { id: 325, name: "Spoink" }, { id: 326, name: "Grumpig" }, { id: 327, name: "Spinda" }, { id: 328, name: "Trapinch" }, { id: 329, name: "Vibrava" }, { id: 330, name: "Flygon" },
        { id: 331, name: "Cacnea" }, { id: 332, name: "Cacturne" }, { id: 333, name: "Swablu" }, { id: 334, name: "Altaria" }, { id: 335, name: "Zangoose" }, { id: 336, name: "Seviper" }, { id: 337, name: "Lunatone" }, { id: 338, name: "Solrock" }, { id: 339, name: "Barboach" }, { id: 340, name: "Whiscash" },
        { id: 341, name: "Corphish" }, { id: 342, name: "Crawdaunt" }, { id: 343, name: "Baltoy" }, { id: 344, name: "Claydol" }, { id: 345, name: "Lileep" }, { id: 346, name: "Cradily" }, { id: 347, name: "Anorith" }, { id: 348, name: "Armaldo" }, { id: 349, name: "Feebas" }, { id: 350, name: "Milotic" },
        { id: 351, name: "Castform" }, { id: 352, name: "Kecleon" }, { id: 353, name: "Shuppet" }, { id: 354, name: "Banette" }, { id: 355, name: "Duskull" }, { id: 356, name: "Dusclops" }, { id: 357, name: "Tropius" }, { id: 358, name: "Chimecho" }, { id: 359, name: "Absol" }, { id: 360, name: "Wynaut" },
        { id: 361, name: "Snorunt" }, { id: 362, name: "Glalie" }, { id: 363, name: "Spheal" }, { id: 364, name: "Sealeo" }, { id: 365, name: "Walrein" }, { id: 366, name: "Clamperl" }, { id: 367, name: "Huntail" }, { id: 368, name: "Gorebyss" }, { id: 369, name: "Relicanth" }, { id: 370, name: "Luvdisc" },
        { id: 371, name: "Bagon" }, { id: 372, name: "Shelgon" }, { id: 373, name: "Salamence" }, { id: 374, name: "Beldum" }, { id: 375, name: "Metang" }, { id: 376, name: "Metagross" }, { id: 377, name: "Regirock" }, { id: 378, name: "Regice" }, { id: 379, name: "Registeel" },
        { id: 380, name: "Latias" }, { id: 381, name: "Latios" }, { id: 382, name: "Kyogre" }, { id: 383, name: "Groudon" }, { id: 384, name: "Rayquaza" }, { id: 385, name: "Jirachi" }, { id: 386, name: "Deoxys" }
    ];

    // Mapping Dex ID to Base Set (1999) Number
    const WOTC_BASE_MAP = {
        65: 1, 9: 2, 113: 3, 6: 4, 35: 5, 130: 6, 107: 7, 68: 8, 82: 9, 150: 10, 34: 11, 38: 12, 62: 13, 26: 14, 3: 15, 145: 16,
        15: 17, 148: 18, 51: 19, 125: 20, 101: 21, 17: 22, 59: 23, 5: 24, 87: 25, 147: 26, 83: 27, 58: 28, 93: 29, 2: 30, 124: 31,
        64: 32, 14: 33, 67: 34, 129: 35, 126: 36, 33: 37, 61: 38, 137: 39, 20: 40, 86: 41, 8: 42, 63: 43, 1: 44, 10: 45, 4: 46,
        50: 47, 84: 48, 96: 49, 92: 50, 109: 51, 66: 52, 81: 53, 11: 54, 32: 55, 95: 56, 16: 57, 25: 58, 60: 59, 77: 60, 19: 61,
        27: 62, 7: 63, 121: 64, 120: 65, 114: 66, 100: 67, 37: 68, 13: 69
    };

    const getDefaultImage = (entry) => {
        if (entry.cardImage) return entry.cardImage;
        if (entry.isTrainer) return 'https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg';
        if (entry.apiId <= 151) return `https://images.pokemontcg.io/sv3pt5/${entry.apiId}.png`;
        return 'https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg';
    };

    const StatsBar = ({ binder, totalCards, ownedCards }) => {
        const totalValue = useMemo(() => {
            return Object.values(binder).reduce((acc, curr) => {
                if (!curr.value) return acc;
                const val = parseFloat(curr.value.replace(/[^0-9.]/g, ''));
                return acc + (isNaN(val) ? 0 : val);
            }, 0);
        }, [binder]);

        const percentage = totalCards > 0 ? Math.round((ownedCards / totalCards) * 100) : 0;

        return (
            <div className="bg-slate-800 border-b border-slate-700 p-2 md:p-3 stats-gradient">
                <div className="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4 text-sm">
                    <div className="flex items-center gap-4">
                        <div className="flex flex-col">
                            <span className="text-slate-400 text-xs uppercase font-bold">Progress</span>
                            <span className="text-white font-bold">{ownedCards} <span className="text-slate-500">/</span> {totalCards} <span className="text-indigo-400 text-xs">({percentage}%)</span></span>
                        </div>
                        <div className="w-24 h-2 bg-slate-700 rounded-full overflow-hidden mt-1">
                            <div className="h-full bg-indigo-500 transition-all duration-500" style={{ width: `${percentage}%` }}></div>
                        </div>
                    </div>
                    
                    <div className="flex flex-col text-right">
                        <span className="text-slate-400 text-xs uppercase font-bold">Total Value</span>
                        <span className="text-green-400 font-bold font-mono text-lg">£{totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {
        const [view, setView] = useState('grid');
        const [selectedEntry, setSelectedEntry] = useState(null);
        const [binder, setBinder] = useState({});
        const [customSlots, setCustomSlots] = useState({}); 
        const [extraPokemon, setExtraPokemon] = useState([]); 
        const [searchQuery, setSearchQuery] = useState("");
        const [showAddModal, setShowAddModal] = useState(false);
        const [toastMsg, setToastMsg] = useState(null);
        const [confirmConfig, setConfirmConfig] = useState(null);
        const [showMobileSearch, setShowMobileSearch] = useState(false); // NEW STATE
        const [showSortMenu, setShowSortMenu] = useState(false); // NEW STATE
        const [sortMode, setSortMode] = useState('dex'); // 'dex', 'value-high', 'value-low'
        
        // Filter States
        const [showFilters, setShowFilters] = useState(false);
        const [showStats, setShowStats] = useState(false); 
        const [showOwnedMenu, setShowOwnedMenu] = useState(false); // NEW STATE
        const [filterSettings, setFilterSettings] = useState({
            showOwned: true, 
            showNotOwned: true,
            showGen1Only: false, 
            showBase151: false, 
            show1999: false, 
            showSlots: true,
            showClown: false, // Changed from showRealOnly
            showDream: false,
            showIdeal: false,
            showTrainers: true, 
            showStandard: true,
            showEX: true, showGX: true, showV: true, showVMAX: true, showVSTAR: true, showMEGA: true,
        });
        
        const [gridColumns, setGridColumns] = useState(0); // 0 = Auto
        const [savedScroll, setSavedScroll] = useState(0);
        const fileInputRef = useRef(null);

        useEffect(() => {
            const savedBinder = localStorage.getItem('project151_binder');
            const savedSlots = localStorage.getItem('project151_slots');
            const savedExtras = localStorage.getItem('project151_extras');
            const savedColumns = localStorage.getItem('project151_gridColumns');
            
            if (savedBinder) setBinder(JSON.parse(savedBinder));
            if (savedSlots) setCustomSlots(JSON.parse(savedSlots));
            if (savedExtras) setExtraPokemon(JSON.parse(savedExtras));
            if (savedColumns) setGridColumns(parseInt(savedColumns));
        }, []);

        useEffect(() => {
            if (view === 'detail') {
                window.scrollTo(0, 0);
            } else {
                const timer = setTimeout(() => {
                    window.scrollTo(0, savedScroll);
                }, 0);
                return () => clearTimeout(timer);
            }
        }, [view]);

        const fullEntries = useMemo(() => {
            let currentDex = 1;
            let result = [];
            
            // Process Base 1-151
            RAW_POKEMON.forEach(raw => {
                let entry;
                if (typeof raw === 'string') {
                    entry = { name: raw, apiId: currentDex, key: currentDex.toString(), isMega: false, displayId: currentDex.toString().padStart(3, '0'), isBase: true, isTrainer: false };
                    currentDex++;
                    result.push(entry);
                } else if (!raw.isMega) {
                    entry = { ...raw, apiId: currentDex, key: currentDex.toString(), isMega: false, displayId: currentDex.toString().padStart(3, '0'), isBase: true, isTrainer: false };
                    currentDex++;
                    result.push(entry);
                }
            });

            // Process Extras (now includes manual IDs and Trainers)
            const sortedExtras = [...extraPokemon].sort((a, b) => a.apiId - b.apiId);
            
            // FILTER LOGIC UPDATED
            if (filterSettings.showGen1Only) {
                // If Gen 1 Only is checked, only show extras with ID <= 151
                const gen1Extras = sortedExtras.filter(e => e.apiId <= 151);
                result = [...result, ...gen1Extras];
            } else {
                // Otherwise show everything (Gen 2, 3, Trainers etc)
                result = [...result, ...sortedExtras];
            }

            // Filter Trainers if hidden
            if (!filterSettings.showTrainers) {
                result = result.filter(e => !e.isTrainer);
            }

            // Re-sort entire list by ID to ensure correct placement
            // Modified Sort: API ID first, then Trainers go AFTER Pokemon of same ID
            result.sort((a, b) => {
                if (a.apiId !== b.apiId) return a.apiId - b.apiId;
                if (a.isTrainer !== b.isTrainer) return a.isTrainer ? 1 : -1;
                return 0;
            });

            // Process Slots
            let finalResult = [];
            const getRarityWeight = (r) => {
                 if (r === 'standard') return 0;
                 if (r === 'EX') return 1;
                 if (r === 'GX') return 2;
                 if (r === 'V') return 3;
                 if (r === 'VMAX') return 4;
                 if (r === 'VSTAR') return 5;
                 if (r === 'MEGA') return 6;
                 return 0;
            };

            result.forEach(entry => {
                finalResult.push(entry);
                if (filterSettings.showSlots && customSlots[entry.key]) {
                    const slotEntries = customSlots[entry.key].map(childKey => {
                        const cardData = binder[childKey];
                        const rarity = cardData ? (cardData.cardType || "standard") : "standard";
                        return {
                            ...entry,
                            key: childKey,
                            isCustom: true,
                            isBase: false,
                            name: entry.name + " (Slot)",
                            _sortWeight: getRarityWeight(rarity),
                            isTrainer: entry.isTrainer
                        };
                    });
                    slotEntries.sort((a, b) => a._sortWeight - b._sortWeight);
                    slotEntries.forEach(s => finalResult.push(s));
                }
            });
            return finalResult;
        }, [customSlots, extraPokemon, filterSettings, binder]);

        const stats = useMemo(() => {
            const currentList = fullEntries;
            const owned = currentList.filter(e => binder[e.key]?.owned).length;
            return { total: currentList.length, owned };
        }, [fullEntries, binder]);

        const handleEntrySelect = (entry) => {
            setSavedScroll(window.scrollY);
            setSelectedEntry(entry);
            setView('detail');
        };

        const saveCardToBinder = (key, data) => {
            const existing = binder[key] || {};
            const ownedStatus = (data.owned !== undefined) ? data.owned : (existing.owned || false);
            const cardValue = (data.value !== undefined) ? data.value : (existing.value || "");
            
            const newBinder = { 
                ...binder, 
                [key]: { 
                    url: data.url, 
                    fanArtUrl: data.fanArtUrl,
                    dreamUrl: data.dreamUrl,
                    idealUrl: data.idealUrl,
                    name: data.name, 
                    owned: ownedStatus, 
                    value: cardValue,
                    cardType: data.cardType || "standard"
                } 
            };
            setBinder(newBinder);
            localStorage.setItem('project151_binder', JSON.stringify(newBinder));
            setToastMsg(`Saved ${data.name}!`);
        };

        const toggleOwnedStatus = (key) => {
            const entry = binder[key] || {};
            const newBinder = { ...binder, [key]: { ...entry, owned: !entry.owned } };
            setBinder(newBinder);
            localStorage.setItem('project151_binder', JSON.stringify(newBinder));
        };

        const addCustomSlot = (parentEntry) => {
            const newKey = `${parentEntry.key}-extra-${Date.now()}`;
            const existingChildren = customSlots[parentEntry.key] || [];
            const newSlots = { ...customSlots, [parentEntry.key]: [...existingChildren, newKey] };
            setCustomSlots(newSlots);
            localStorage.setItem('project151_slots', JSON.stringify(newSlots));
            
            const newEntry = { ...parentEntry, key: newKey, isCustom: true, name: parentEntry.name + " (Slot)" };
            setSelectedEntry(newEntry);
            setToastMsg("Extra Slot Added!");
        };

        const removeCustomSlot = (entry) => {
            setConfirmConfig({
                msg: "Delete this extra slot permanently?",
                action: () => {
                    const parentKey = Object.keys(customSlots).find(pKey => customSlots[pKey].includes(entry.key));
                    if (parentKey) {
                        const newChildren = customSlots[parentKey].filter(k => k !== entry.key);
                        const newSlots = { ...customSlots, [parentKey]: newChildren };
                        setCustomSlots(newSlots);
                        localStorage.setItem('project151_slots', JSON.stringify(newSlots));
                        const newBinder = { ...binder };
                        delete newBinder[entry.key];
                        setBinder(newBinder);
                        localStorage.setItem('project151_binder', JSON.stringify(newBinder));
                        setView('grid');
                        setToastMsg("Slot Removed");
                    }
                }
            });
        };
        
        const deleteExtraPokemon = (entry) => {
            setConfirmConfig({
                msg: `Remove ${entry.name} from your collection?`,
                action: () => {
                    const newExtras = extraPokemon.filter(p => p.key !== entry.key);
                    setExtraPokemon(newExtras);
                    localStorage.setItem('project151_extras', JSON.stringify(newExtras));
                    const newBinder = { ...binder };
                    delete newBinder[entry.key];
                    const newSlots = {...customSlots};
                    delete newSlots[entry.key];
                    setBinder(newBinder);
                    setCustomSlots(newSlots);
                    localStorage.setItem('project151_binder', JSON.stringify(newBinder));
                    localStorage.setItem('project151_slots', JSON.stringify(newSlots));
                    setView('grid');
                    setToastMsg("Entry Removed");
                }
            });
        };
        
        const swapSlotWithParent = (childEntry) => {
            const parentKey = Object.keys(customSlots).find(pKey => customSlots[pKey].includes(childEntry.key));
            if (!parentKey) return;
            
            setConfirmConfig({
                msg: `Promote this card to the Main Entry? The current Main card will move to this slot.`,
                action: () => {
                    const parentData = binder[parentKey] || {};
                    const childData = binder[childEntry.key] || {};
                    
                    const newBinder = {
                        ...binder,
                        [parentKey]: { ...childData },
                        [childEntry.key]: { ...parentData }
                    };
                    
                    setBinder(newBinder);
                    localStorage.setItem('project151_binder', JSON.stringify(newBinder));
                    setToastMsg("Entries Swapped!");
                }
            });
        };

        const handleAddPokemon = (newPoke) => {
            const newList = [...extraPokemon, newPoke];
            setExtraPokemon(newList);
            localStorage.setItem('project151_extras', JSON.stringify(newList));
            setShowAddModal(false);
            setToastMsg(`${newPoke.name} Added!`);
        };

        const handleSetGridColumns = (cols) => {
            setGridColumns(cols);
            localStorage.setItem('project151_gridColumns', cols.toString());
        };

        const handleExportCSV = () => {
            const generateAllEntries = () => {
                let currentDex = 1;
                let result = [];
                RAW_POKEMON.forEach(raw => {
                    let entry;
                    if (typeof raw === 'string') {
                        entry = { name: raw, apiId: currentDex, key: currentDex.toString(), isMega: false, displayId: currentDex.toString().padStart(3, '0'), isTrainer: false };
                        currentDex++;
                        result.push(entry);
                    } else if (!raw.isMega) {
                        entry = { ...raw, apiId: currentDex, key: currentDex.toString(), isMega: false, displayId: currentDex.toString().padStart(3, '0'), isTrainer: false };
                        currentDex++;
                        result.push(entry);
                    }
                });
                const sortedExtras = [...extraPokemon].sort((a, b) => a.apiId - b.apiId);
                result = [...result, ...sortedExtras];
                let finalResult = [];
                result.forEach(entry => {
                    finalResult.push(entry);
                    if (customSlots[entry.key]) {
                        customSlots[entry.key].forEach(childKey => {
                            finalResult.push({ ...entry, key: childKey, isCustom: true, name: entry.name + " (Slot)", isTrainer: entry.isTrainer });
                        });
                    }
                });
                return finalResult;
            };

            const allEntries = generateAllEntries();
            const headers = ["SystemKey", "Name", "ApiId", "DisplayId", "Category", "ParentKey", "Owned", "Value", "ImageURL", "FanArtURL", "CardType", "DreamURL", "IdealURL", "IsTrainer"];
            const rows = [headers.join(",")];

            allEntries.forEach(entry => {
                const b = binder[entry.key] || {};
                let category = "Base";
                if (entry.isMega) category = "Mega";
                if (extraPokemon.find(e => e.key === entry.key)) category = "Manual";
                if (entry.isCustom) category = "Slot";
                let parentKey = "";
                if (entry.isCustom) parentKey = Object.keys(customSlots).find(p => customSlots[p].includes(entry.key)) || "";

                const safeName = `"${(b.name || entry.name).replace(/"/g, '""')}"`;
                const safeValue = `"${(b.value || "").replace(/"/g, '""')}"`;
                const safeUrl = `"${(b.url || "").replace(/"/g, '""')}"`;
                const safeFanArt = `"${(b.fanArtUrl || "").replace(/"/g, '""')}"`;
                const safeDream = `"${(b.dreamUrl || "").replace(/"/g, '""')}"`;
                const safeIdeal = `"${(b.idealUrl || "").replace(/"/g, '""')}"`;
                const safeCardType = `"${(b.cardType || "standard").replace(/"/g, '""')}"`;

                const hasData = b.owned || b.url || b.value || b.fanArtUrl || b.dreamUrl || b.idealUrl || (b.cardType && b.cardType !== 'standard');
                const isStructural = category === "Manual" || category === "Slot";

                if (hasData || isStructural) {
                    const row = [entry.key, safeName, entry.apiId, entry.displayId, category, parentKey, b.owned ? "TRUE" : "FALSE", safeValue, safeUrl, safeFanArt, safeCardType, safeDream, safeIdeal, entry.isTrainer ? "TRUE" : "FALSE"];
                    rows.push(row.join(","));
                }
            });

            const blob = new Blob([rows.join("\n")], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'project151_collection.csv';
            a.click();
            URL.revokeObjectURL(url);
            setToastMsg("Collection Exported!");
        };

        const handleImportCSV = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split("\n");
                    const newBinder = {};
                    const newExtras = [];
                    const newSlots = {};
                    for(let i=1; i<lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const row = parseCSVRow(lines[i]); 
                        if (row.length < 9) continue;
                        const [key, name, apiId, displayId, category, parentKey, ownedStr, value, url, fanArtUrl, cardType, dreamUrl, idealUrl, isTrainerStr] = row;
                        const isOwned = ownedStr === "TRUE";
                        const isTrainer = isTrainerStr === "TRUE";
                        const typeVal = cardType || "standard";
                        if (isOwned || value || url || name || fanArtUrl || dreamUrl || idealUrl || typeVal !== "standard") {
                            newBinder[key] = { 
                                name: name, 
                                owned: isOwned, 
                                value: value, 
                                url: url, 
                                fanArtUrl: fanArtUrl || "", 
                                dreamUrl: dreamUrl || "", 
                                idealUrl: idealUrl || "",
                                cardType: typeVal 
                            };
                        }
                        if (category === "Manual") {
                            newExtras.push({ name: name, apiId: parseInt(apiId) || 0, key: key, isMega: false, displayId: displayId, cardImage: null, isTrainer: isTrainer });
                        }
                        if (category === "Slot" && parentKey) {
                            if (!newSlots[parentKey]) newSlots[parentKey] = [];
                            newSlots[parentKey].push(key);
                        }
                    }
                    setBinder(newBinder);
                    setExtraPokemon(newExtras);
                    setCustomSlots(newSlots);
                    localStorage.setItem('project151_binder', JSON.stringify(newBinder));
                    localStorage.setItem('project151_extras', JSON.stringify(newExtras));
                    localStorage.setItem('project151_slots', JSON.stringify(newSlots));
                    setToastMsg("Collection Imported Successfully!");
                } catch (err) {
                    console.error(err);
                    setToastMsg("Error parsing CSV");
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        };

        const handleClearData = () => {
            setConfirmConfig({
                msg: "WARNING: This will permanently delete all your collected cards, custom slots, and manual entries. Start a fresh collection?",
                action: () => {
                    localStorage.removeItem('project151_binder');
                    localStorage.removeItem('project151_slots');
                    localStorage.removeItem('project151_extras');
                    setBinder({});
                    setCustomSlots({});
                    setExtraPokemon([]);
                    setToastMsg("Data Cleared - Fresh Start!");
                }
            });
        };

        const toggleFilter = (key) => setFilterSettings(prev => ({ ...prev, [key]: !prev[key] }));
        const scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });
        const scrollToBottom = () => window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });

        return (
            <div className="min-h-screen">
                <Toast msg={toastMsg} onClose={() => setToastMsg(null)} />
                <ConfirmDialog config={confirmConfig} onCancel={() => setConfirmConfig(null)} />
                <input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />

                {view === 'grid' && <DexJumpSidebar entries={fullEntries} />}
                
                {/* EXISTING BOTTOM RIGHT SCROLL BUTTONS */}
                {view === 'grid' && (
                    <div className="fixed bottom-6 right-6 z-30 flex flex-col gap-2">
                        <button onClick={scrollToTop} className="bg-slate-800/80 backdrop-blur border border-slate-700 p-3 rounded-full text-indigo-400 hover:bg-slate-700 hover:text-white shadow-lg transition-all active:scale-95"><IconArrowUp /></button>
                        <button onClick={scrollToBottom} className="bg-slate-800/80 backdrop-blur border border-slate-700 p-3 rounded-full text-indigo-400 hover:bg-slate-700 hover:text-white shadow-lg transition-all active:scale-95"><IconArrowDown /></button>
                    </div>
                )}

                {/* NEW BOTTOM LEFT SEARCH BUTTON (MOBILE ONLY) */}
                {view === 'grid' && (
                    <>
                        <div className="fixed bottom-6 left-6 z-30 md:hidden">
                            <button 
                                onClick={() => setShowMobileSearch(!showMobileSearch)} 
                                className={`p-3 rounded-full text-white shadow-lg transition-all active:scale-95 flex items-center justify-center border ${showMobileSearch ? 'bg-indigo-600 border-indigo-400' : 'bg-slate-800/80 backdrop-blur border-slate-700 text-indigo-400'}`}
                            >
                                {showMobileSearch ? <IconX /> : <IconSearch />}
                            </button>
                        </div>

                        {showMobileSearch && (
                            <div className="fixed bottom-20 left-6 z-30 md:hidden animate-zoom origin-bottom-left">
                                <div className="relative">
                                    <input 
                                        autoFocus
                                        type="text" 
                                        placeholder="Search Pokemon..." 
                                        className="bg-slate-800/95 backdrop-blur border border-indigo-500 rounded-full pl-4 pr-10 py-3 text-sm focus:outline-none shadow-2xl w-64 text-white" 
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)} 
                                    />
                                    {searchQuery && (
                                        <button 
                                            onClick={() => setSearchQuery('')}
                                            className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"
                                        >
                                            <IconX />
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </>
                )}

                <header className="sticky top-0 z-40 bg-slate-900/95 backdrop-blur-md border-b border-slate-700 shadow-xl transition-all">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-y-2">
                        {/* APP ICON & TITLE - CLICK TO REFRESH */}
                        <div className="flex items-center gap-3 cursor-pointer select-none hover:opacity-80 transition-opacity" onClick={() => window.location.reload()}>
                            <div className="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-slate-900"><IconDna /></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight text-white">151 <span className="text-indigo-400 text-sm font-normal">V3.5</span></h1>
                            </div>
                        </div>

                        <div className="flex items-center gap-2">
                             {view === 'grid' && (
                                <div className="hidden md:flex relative">
                                    <div className="absolute left-3 top-2.5 text-slate-500"><IconSearch /></div>
                                    <input type="text" placeholder="Search..." className="bg-slate-800 border border-slate-700 rounded-full pl-9 pr-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 w-48" onChange={(e) => setSearchQuery(e.target.value)} />
                                </div>
                            )}
                            <button onClick={() => setShowStats(!showStats)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors text-xs font-bold border border-transparent ${showStats ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`} title="Toggle Progress & Value"><IconGraph /></button>
                            <button onClick={() => setShowFilters(!showFilters)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full transition-colors text-xs font-bold border border-transparent ${showFilters ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`} title="Filters"><IconFilter /></button>
                            <button onClick={handleExportCSV} className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 text-slate-400 hover:text-green-400 transition-colors text-xs font-bold border border-transparent hover:border-green-900" title="Download CSV"><IconDownload /> <span className="hidden sm:inline">CSV</span></button>
                            <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 text-slate-400 hover:text-blue-400 transition-colors text-xs font-bold border border-transparent hover:border-blue-900" title="Upload CSV"><IconUpload /></button>
                            <button onClick={handleClearData} className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 text-slate-400 hover:text-red-400 transition-colors text-xs font-bold border border-transparent hover:border-red-900" title="Clear Data / New CSV"><IconTrash /></button>
                        </div>
                    </div>

                    {/* STATS BAR */}
                    {view === 'grid' && showStats && <StatsBar binder={binder} totalCards={stats.total} ownedCards={stats.owned} />}

                    {showFilters && (
                        <div className="border-t border-slate-800 bg-slate-900/80 p-3 relative">
                            <div className="max-w-7xl mx-auto flex flex-col gap-4 text-sm">
                                <div className="flex flex-col md:flex-row gap-6 justify-between">
                                    <div className="flex flex-wrap gap-1.5 items-center">
                                        {/* Removed Owned/Missing buttons from here */}

                                        {/* GEN 1 ONLY TOGGLE */}
                                        <button 
                                            onClick={() => toggleFilter('showGen1Only')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showGen1Only ? "bg-indigo-600 text-white border-indigo-500 hover:bg-indigo-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            151
                                        </button>

                                        {/* MODERN 151 TOGGLE */}
                                        <button 
                                            onClick={() => { toggleFilter('showBase151'); if(filterSettings.show1999) setFilterSettings(prev => ({...prev, show1999: false})); }} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showBase151 ? "bg-purple-600 text-white border-purple-500 hover:bg-purple-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            NEW
                                        </button>

                                        {/* 1999 BASE SET TOGGLE */}
                                        <button 
                                            onClick={() => { toggleFilter('show1999'); if(filterSettings.showBase151) setFilterSettings(prev => ({...prev, showBase151: false})); }} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.show1999 ? "bg-yellow-600 text-white border-yellow-500 hover:bg-yellow-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            OG
                                        </button>

                                        <button 
                                            onClick={() => toggleFilter('showSlots')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showSlots ? "bg-indigo-600 text-white border-indigo-500 hover:bg-indigo-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            🃏+
                                        </button>

                                        {/* TRAINER TOGGLE */}
                                        <button 
                                            onClick={() => toggleFilter('showTrainers')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showTrainers ? "bg-indigo-600 text-white border-indigo-500 hover:bg-indigo-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            🙎‍♂️
                                        </button>
                                        
                                        <div className="w-px h-4 bg-slate-700 mx-1"></div>

                                        <button 
                                            onClick={() => toggleFilter('showDream')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showDream ? "bg-amber-600 text-white border-amber-500 hover:bg-amber-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            👑
                                        </button>

                                        <button 
                                            onClick={() => toggleFilter('showIdeal')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showIdeal ? "bg-cyan-600 text-white border-cyan-500 hover:bg-cyan-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            🖼️
                                        </button>

                                        <button 
                                            onClick={() => toggleFilter('showClown')} 
                                            className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${filterSettings.showClown ? "bg-pink-600 text-white border-pink-500 hover:bg-pink-500" : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"}`}
                                        >
                                            🤡
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="pt-2 border-t border-slate-800 flex flex-wrap gap-4 justify-between items-center">
                                    <div className="flex flex-wrap gap-1.5 items-center">
                                        {[
                                            { id: "Standard", label: "S" },
                                            { id: "EX", label: "EX" },
                                            { id: "GX", label: "GX" },
                                            { id: "V", label: "V" },
                                            { id: "VMAX", label: "VM" },
                                            { id: "VSTAR", label: "V⭐️" },
                                            { id: "MEGA", label: "M" }
                                        ].map(r => {
                                            const key = `show${r.id}`;
                                            const isActive = filterSettings[key];
                                            return (
                                                <button 
                                                    key={r.id} 
                                                    onClick={() => toggleFilter(key)} 
                                                    className={`px-3 py-1 rounded-full text-[10px] font-bold transition-all border shadow-sm ${
                                                        isActive 
                                                        ? "bg-indigo-600 text-white border-indigo-500 hover:bg-indigo-500" 
                                                        : "bg-slate-800 text-slate-500 border-slate-700 hover:border-slate-500 hover:text-slate-400"
                                                    }`}
                                                >
                                                    {r.label}
                                                </button>
                                            )
                                        })}
                                    </div>

                                    {/* RIGHT SIDE CONTROLS: Owned Toggle + Columns */}
                                    <div className="flex items-center gap-3 relative">
                                        {/* OWNED/MISSING TOGGLE BUTTON (Half Green/Red) */}
                                        <button 
                                            onClick={() => setShowOwnedMenu(!showOwnedMenu)}
                                            className="w-6 h-6 rounded-full shadow-md border border-slate-500 hover:border-white hover:scale-110 transition-all"
                                            style={{ background: 'linear-gradient(135deg, #10b981 50%, #f43f5e 50%)' }}
                                            title="Filter Owned vs Missing"
                                        />

                                        {/* OWNED/MISSING MENU POPUP */}
                                        {showOwnedMenu && (
                                            <div className="absolute top-full right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl p-2 shadow-2xl flex flex-col gap-2 z-50 animate-zoom min-w-[100px]">
                                                <button 
                                                    onClick={() => toggleFilter('showOwned')} 
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border flex items-center justify-between ${filterSettings.showOwned ? "bg-green-900/50 text-green-400 border-green-500" : "bg-slate-700 text-slate-500 border-slate-600"}`}
                                                >
                                                    <span>Owned</span>
                                                    {filterSettings.showOwned && <IconCheck />}
                                                </button>
                                                <button 
                                                    onClick={() => toggleFilter('showNotOwned')} 
                                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border flex items-center justify-between ${filterSettings.showNotOwned ? "bg-rose-900/50 text-rose-400 border-rose-500" : "bg-slate-700 text-slate-500 border-slate-600"}`}
                                                >
                                                    <span>Missing</span>
                                                    {filterSettings.showNotOwned && <IconCheck />}
                                                </button>
                                            </div>
                                        )}

                                        {/* COLUMN DROPDOWN */}
                                        <select 
                                            value={gridColumns} 
                                            onChange={(e) => handleSetGridColumns(parseInt(e.target.value))} 
                                            className="bg-slate-800 text-white text-xs font-bold rounded border border-slate-600 px-2 py-1 focus:ring-1 focus:ring-indigo-500 outline-none cursor-pointer"
                                            title="Columns"
                                        >
                                            <option value={0}>A</option>
                                            <option value={1}>1</option>
                                            <option value={2}>2</option>
                                            <option value={3}>3</option>
                                            <option value={4}>4</option>
                                            <option value={5}>5</option>
                                            <option value={6}>6</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </header>

                {showAddModal && <AddPokemonModal onClose={() => setShowAddModal(false)} onAdd={handleAddPokemon} />}

                <main className="max-w-7xl mx-auto px-4 py-6">
                    {view === 'grid' ? (
                        <GridView 
                            entries={fullEntries}
                            searchQuery={searchQuery} 
                            binder={binder} 
                            gridColumns={gridColumns}
                            filterSettings={filterSettings}
                            onSelect={handleEntrySelect} 
                            onToggleOwned={toggleOwnedStatus} 
                            onOpenAddModal={() => setShowAddModal(true)}
                        />
                    ) : (
                        <DetailView 
                            entry={selectedEntry} 
                            binderEntry={binder[selectedEntry.key]}
                            onSave={saveCardToBinder} 
                            onToggleOwned={toggleOwnedStatus}
                            onAddSlot={addCustomSlot}
                            onRemoveSlot={removeCustomSlot}
                            onSwapSlot={swapSlotWithParent}
                            onDeletePokemon={deleteExtraPokemon}
                            onBack={() => setView('grid')}
                            filterSettings={filterSettings}
                        />
                    )}
                </main>

                <footer className="text-center py-6 text-[10px] text-slate-600 uppercase tracking-widest font-bold opacity-50 hover:opacity-100 transition-opacity select-none">
                    Created by ConorRM
                </footer>
            </div>
        );
    };

    const DexJumpSidebar = ({ entries }) => {
        const scrollToDex = (dexNum) => {
            const targetEntry = entries.find(e => e.apiId >= dexNum);
            if (targetEntry) {
                const el = document.getElementById(`poke-card-${targetEntry.key}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };
        const handleTouchMove = (e) => {
            const touch = e.touches[0];
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (el && el.dataset.jump) scrollToDex(parseInt(el.dataset.jump));
        };
        const maxId = entries.length > 0 ? entries[entries.length - 1].apiId : 151;
        const ticks = [1];
        const step = maxId > 251 ? 50 : 30;
        for (let i = step; i < maxId; i += step) ticks.push(i);
        if (maxId > 1) ticks.push(maxId);

        return (
            <div className="fixed right-1 top-1/2 transform -translate-y-1/2 z-50 flex flex-col gap-1 items-center bg-black/40 backdrop-blur-sm p-1 rounded-full py-2 dex-scrubber" onTouchMove={handleTouchMove}>
                {ticks.map(t => (
                    <div key={t} onClick={() => scrollToDex(t)} data-jump={t} className="text-[9px] font-bold text-slate-300 hover:text-white cursor-pointer w-6 h-4 flex items-center justify-center select-none">{t}</div>
                ))}
            </div>
        );
    };

    const AddPokemonModal = ({ onClose, onAdd }) => {
        const [mode, setMode] = useState('list'); // 'list' or 'manual'
        const [activeGen, setActiveGen] = useState(2);
        const [selectedId, setSelectedId] = useState("");
        const [url, setUrl] = useState("");
        
        // Manual States
        const [manualName, setManualName] = useState("");
        const [manualId, setManualId] = useState("");
        const [isTrainer, setIsTrainer] = useState(false);

        const currentList = activeGen === 2 ? GEN_2_POKEMON : GEN_3_POKEMON;

        const handleSubmit = () => {
            if (mode === 'list') {
                if (!selectedId) return;
                const poke = currentList.find(p => p.id === parseInt(selectedId));
                if (!poke) return;
                const newPoke = { name: poke.name, apiId: poke.id, key: poke.id.toString() + "-" + poke.name.toLowerCase(), isMega: false, displayId: poke.id.toString().padStart(3, '0'), cardImage: url || null, isTrainer: false, isBase: false };
                onAdd(newPoke);
            } else {
                if (!manualName || !manualId) return;
                const idNum = parseInt(manualId);
                const newPoke = { 
                    name: manualName, 
                    apiId: idNum, 
                    key: idNum.toString() + "-" + manualName.toLowerCase().replace(/ /g, '-'), 
                    isMega: false, 
                    displayId: idNum.toString().padStart(3, '0'), 
                    cardImage: url || null,
                    isTrainer: isTrainer,
                    isBase: false
                };
                onAdd(newPoke);
            }
        };

        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                <div className="bg-slate-800 rounded-xl p-6 w-full max-w-md border border-slate-700">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-bold">Add Entry</h3>
                        <button onClick={onClose}><IconX /></button>
                    </div>

                    <div className="flex gap-2 mb-4 bg-slate-900/50 p-1 rounded-lg">
                        <button onClick={() => setMode('list')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-colors ${mode === 'list' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}>From Pokedex</button>
                        <button onClick={() => setMode('manual')} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-colors ${mode === 'manual' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`}>Manual Input</button>
                    </div>

                    <div className="space-y-4">
                        {mode === 'list' ? (
                            <>
                                <div className="flex gap-2 mb-2">
                                    <button onClick={() => { setActiveGen(2); setSelectedId(""); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${activeGen === 2 ? 'bg-slate-700 text-white ring-1 ring-indigo-500' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>Gen 2</button>
                                    <button onClick={() => { setActiveGen(3); setSelectedId(""); }} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${activeGen === 3 ? 'bg-slate-700 text-white ring-1 ring-indigo-500' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>Gen 3</button>
                                </div>
                                <div>
                                    <label className="block text-xs text-slate-400 mb-1">Select Pokemon</label>
                                    <select className="w-full glass-input rounded px-3 py-2 text-white" value={selectedId} onChange={(e) => setSelectedId(e.target.value)}>
                                        <option value="">-- Choose a Pokemon --</option>
                                        {currentList.map(p => <option key={p.id} value={p.id}>#{p.id} - {p.name}</option>)}
                                    </select>
                                </div>
                            </>
                        ) : (
                            <>
                                <div>
                                    <label className="block text-xs text-slate-400 mb-1">Entry Name</label>
                                    <input type="text" className="w-full glass-input rounded px-3 py-2 text-white" placeholder="e.g. Lucario, Cynthia..." value={manualName} onChange={(e) => setManualName(e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs text-slate-400 mb-1">Sort ID Number</label>
                                    <input type="number" className="w-full glass-input rounded px-3 py-2 text-white" placeholder="e.g. 448 (Tip: Use 1000+ for Trainers)" value={manualId} onChange={(e) => setManualId(e.target.value)} />
                                    <p className="text-[10px] text-slate-500 mt-1">This determines where it sits in the grid.</p>
                                </div>
                                <div className="flex items-center gap-3 bg-slate-900 px-3 py-2 rounded-lg border border-slate-700 mt-2">
                                    <div className="flex-1">
                                        <span className="text-sm font-bold text-white block">Is this a Trainer?</span>
                                        <span className="text-xs text-slate-400">Adds separation line in grid</span>
                                    </div>
                                    <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="trainerToggle" id="trainerToggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0" checked={isTrainer} onChange={() => setIsTrainer(!isTrainer)} />
                                        <label htmlFor="trainerToggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${isTrainer ? 'bg-indigo-500' : 'bg-slate-600'}`}></label>
                                    </div>
                                </div>
                            </>
                        )}

                        <div>
                            <label className="block text-xs text-slate-400 mb-1">Default Image URL (Optional)</label>
                            <input type="text" className="w-full glass-input rounded px-3 py-2 text-white" placeholder="https://..." value={url} onChange={(e) => setUrl(e.target.value)} />
                        </div>
                        <button onClick={handleSubmit} disabled={mode === 'list' ? !selectedId : (!manualName || !manualId)} className={`w-full py-3 rounded-lg font-bold mt-4 shadow-lg transition-colors ${((mode === 'list' && selectedId) || (mode === 'manual' && manualName && manualId)) ? 'bg-indigo-600 hover:bg-indigo-500 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>Add to List</button>
                    </div>
                </div>
            </div>
        );
    };

    const GridView = ({ entries, searchQuery, binder, gridColumns, onSelect, onOpenAddModal, filterSettings, onToggleOwned }) => {
        const filteredList = useMemo(() => {
            return entries.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase()) || p.displayId.includes(searchQuery);
                if (!matchesSearch) return false;
                
                // OWNERSHIP FILTER
                const cardData = binder[p.key];
                const isOwned = cardData?.owned || false;

                if (isOwned && !filterSettings.showOwned) return false;
                if (!isOwned && !filterSettings.showNotOwned) return false;

                if (p.isBase) return true;
                
                const rarity = cardData?.cardType || "standard";
                const rKey = `show${rarity === "standard" ? "Standard" : rarity}`;
                
                // FIXED: Changed filterSettings.showMega to filterSettings.showMEGA
                if (rarity === "MEGA") return filterSettings.showMEGA;
                
                return filterSettings[rKey] !== false; 
            });
        }, [searchQuery, entries, binder, filterSettings]);

        let lastWasTrainer = false;

        return (
            <div className={`grid ${gridColumns === 0 ? 'grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6' : `grid-cols-${gridColumns}`} gap-3 md:gap-6`}>
                {filteredList.map((entry, index) => {
                    const customCard = binder[entry.key];
                    const isOwned = customCard && customCard.owned;
                    let imageSrc = getDefaultImage(entry);
                    const hasRealUrl = customCard && customCard.url;
                    
                    const prevEntry = filteredList[index - 1];
                    const nextEntry = filteredList[index + 1];

                    // Logic: If current is Trainer and previous wasn't, force new row (start of block)
                    const isTrainerBlockStart = entry.isTrainer && (!prevEntry || !prevEntry.isTrainer);
                    // Logic: If current is Trainer and next isn't, show break (end of block)
                    const isTrainerBlockEnd = entry.isTrainer && (!nextEntry || !nextEntry.isTrainer);

                    const hasFanArt = customCard && customCard.fanArtUrl;
                    const hasDream = customCard && customCard.dreamUrl;
                    const hasIdeal = customCard && customCard.idealUrl;
                    
                    let showingFanArt = false;
                    let showingDream = false;
                    let showingIdeal = false;
                    
                    // IMAGE SOURCE LOGIC
                    if (filterSettings.show1999 && WOTC_BASE_MAP[entry.apiId]) {
                        // 1999 Base Set Logic
                        imageSrc = `https://images.pokemontcg.io/base1/${WOTC_BASE_MAP[entry.apiId]}_hires.png`;
                    } else if (filterSettings.showBase151 && entry.isBase && entry.apiId <= 151) {
                        // Modern 151 Logic
                        imageSrc = `https://images.pokemontcg.io/sv3pt5/${entry.apiId}_hires.png`;
                    } else if (filterSettings.showClown) {
                        // CLOWN MODE ON: Prioritize Fan Art / Ideal / Dream
                        if (hasIdeal && filterSettings.showIdeal) {
                            imageSrc = customCard.idealUrl;
                            showingIdeal = true;
                        } else if (hasDream && filterSettings.showDream) {
                            imageSrc = customCard.dreamUrl;
                            showingDream = true;
                        } else if (hasFanArt) { 
                            imageSrc = customCard.fanArtUrl; 
                            showingFanArt = true; 
                        } else if (hasRealUrl) {
                            imageSrc = customCard.url;
                        }
                    } else {
                        // DEFAULT MODE (CLOWN OFF): Prioritize Real
                        if (hasRealUrl) {
                            imageSrc = customCard.url;
                        } else if (hasIdeal && filterSettings.showIdeal) {
                            imageSrc = customCard.idealUrl;
                            showingIdeal = true;
                        } else if (hasDream && filterSettings.showDream) {
                            imageSrc = customCard.dreamUrl;
                            showingDream = true;
                        } else if (hasFanArt) { 
                            imageSrc = customCard.fanArtUrl; 
                            showingFanArt = true; 
                        }
                    }

                    if (entry.isCustom && !isOwned && !imageSrc.startsWith("http")) imageSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTQwIiBmaWxsPSIjMWUxZTFlIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjE0MCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSI1MCIgeT0iNzAiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM1NTUiIHN0eWxlPSJmb250LXNpemU6MTJweCI+RW1wdHkgU2xvdDwvdGV4dD48L3N2Zz4=';
                   
                    const rarity = customCard?.cardType || "standard";
                    let cardBorderClass = "border-slate-700";
                    let badgeClass = "bg-black/60 text-yellow-400";
                    let badgeText = '#' + entry.displayId;

                    if (rarity === "MEGA") { cardBorderClass = "rarity-mega"; badgeClass = "badge-mega"; badgeText = "MEGA"; } 
                    else if (rarity === "EX") { cardBorderClass = "rarity-ex"; badgeClass = "badge-ex"; badgeText = "EX"; } 
                    else if (rarity === "GX") { cardBorderClass = "rarity-gx"; badgeClass = "badge-gx"; badgeText = "GX"; } 
                    else if (rarity === "V") { cardBorderClass = "rarity-v"; badgeClass = "badge-v"; badgeText = "V"; } 
                    else if (rarity === "VMAX") { cardBorderClass = "rarity-vmax"; badgeClass = "badge-vmax"; badgeText = "VMAX"; } 
                    else if (rarity === "VSTAR") { cardBorderClass = "rarity-vstar"; badgeClass = "badge-vstar"; badgeText = "VSTAR"; } 
                    else if (entry.isMega) { cardBorderClass = "mega-glow border-purple-500"; badgeClass = "mega-badge text-white"; badgeText = "MEGA"; }
                    else if (entry.isTrainer) { badgeClass = "bg-indigo-900 text-indigo-200"; badgeText = "TRAINER"; cardBorderClass = "border-indigo-900"; }

                    if (isOwned && rarity === "standard" && !entry.isMega) cardBorderClass = "border-green-500";
                    else if (entry.isCustom && rarity === "standard") cardBorderClass = "extra-border border-blue-400";

                    return (
                        <React.Fragment key={entry.key}>
                            {/* Force new row before trainers start */}
                            {isTrainerBlockStart && <div className="trainer-break trainer-break-top"></div>}

                            <div id={`poke-card-${entry.key}`} onClick={() => onSelect(entry)} className={`card-hover bg-slate-800 rounded-lg overflow-hidden cursor-pointer group relative border ${cardBorderClass}`}>
                                <div className={`absolute top-1 left-1 z-10 px-1.5 py-0.5 rounded text-[10px] font-mono font-bold ${badgeClass}`}>{badgeText}</div>
                                
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onToggleOwned(entry.key); }}
                                    className={`absolute top-1 right-1 z-20 rounded-full p-1.5 transition-colors shadow-lg border border-transparent ${isOwned ? "bg-green-600 text-white" : "bg-slate-900/80 text-slate-500 hover:text-white hover:bg-slate-700"}`}
                                >
                                    <IconCheck />
                                </button>

                                {!isOwned && entry.isCustom && <div className="absolute top-8 right-2 z-10 text-slate-500 text-[10px] font-bold">EXTRA</div>}
                                
                                {showingFanArt && !filterSettings.showBase151 && !filterSettings.show1999 && <div className="absolute bottom-1 right-1 z-10 text-white text-[9px] px-1.5 py-0.5 rounded-full flex items-center gap-1 shadow-lg font-bold fan-art-badge"><IconPalette /> ART</div>}
                                {showingDream && !filterSettings.showBase151 && !filterSettings.show1999 && <div className="absolute bottom-1 right-1 z-10 text-white text-[9px] px-1.5 py-0.5 rounded-full flex items-center gap-1 shadow-lg font-bold dream-badge"><IconStar /> DREAM</div>}
                                {showingIdeal && !filterSettings.showBase151 && !filterSettings.show1999 && <div className="absolute bottom-1 right-1 z-10 text-white text-[9px] px-1.5 py-0.5 rounded-full flex items-center gap-1 shadow-lg font-bold ideal-badge"><IconSparkles /> IDEAL</div>}

                                <div className="aspect-[2.5/3.5] bg-slate-900 relative">
                                    <img 
                                        src={imageSrc} 
                                        alt={entry.name} 
                                        className="w-full h-full object-contain p-1" 
                                        loading="lazy" 
                                        onError={(e) => { e.target.onerror = null; e.target.src = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg"; }} 
                                    />
                                </div>
                                <div className={`p-2 text-center ${entry.isMega || rarity !== "standard" ? 'bg-gradient-to-t from-slate-900 to-slate-800' : 'bg-slate-800'}`}>
                                    <h3 className={`font-bold text-xs md:text-sm truncate ${entry.isMega ? 'text-purple-300' : rarity !== "standard" ? 'text-white' : 'text-white'}`}>
                                        {entry.name.replace(" (Slot)", "")}
                                        {entry.isCustom && <span className="text-blue-400 ml-1 text-[10px] uppercase"></span>}
                                    </h3>
                                </div>
                            </div>

                            {/* Break at bottom after trainers end */}
                            {isTrainerBlockEnd && <div className="trainer-break trainer-break-bottom"></div>}
                        </React.Fragment>
                    );
                })}

                {!searchQuery && (
                    <div onClick={onOpenAddModal} className="card-hover bg-slate-800/50 rounded-lg overflow-hidden cursor-pointer border add-card-border flex flex-col items-center justify-center text-green-400 gap-2 aspect-[2.5/3.5]">
                        <div className="w-12 h-12 rounded-full bg-green-900/30 flex items-center justify-center"><IconPlus /></div>
                        <span className="text-sm font-bold text-center px-4">Add Entry</span>
                    </div>
                )}
            </div>
        );
    };

    const DetailView = ({ entry, binderEntry, onSave, onToggleOwned, onBack, onAddSlot, onRemoveSlot, onDeletePokemon, onSwapSlot, filterSettings }) => {
        const [manualUrl, setManualUrl] = useState(binderEntry?.url || "");
        const [fanArtUrl, setFanArtUrl] = useState(binderEntry?.fanArtUrl || ""); 
        const [dreamUrl, setDreamUrl] = useState(binderEntry?.dreamUrl || ""); 
        const [idealUrl, setIdealUrl] = useState(binderEntry?.idealUrl || ""); 
        const [manualName, setManualName] = useState(binderEntry?.name || entry.name);
        const [manualValue, setManualValue] = useState(binderEntry?.value || "");
        const [selectedRarity, setSelectedRarity] = useState(binderEntry?.cardType || "standard");
        const [showImagePreview, setShowImagePreview] = useState(false);

        useEffect(() => {
            setManualUrl(binderEntry?.url || "");
            setFanArtUrl(binderEntry?.fanArtUrl || "");
            setDreamUrl(binderEntry?.dreamUrl || "");
            setIdealUrl(binderEntry?.idealUrl || "");
            setManualName(binderEntry?.name || entry.name);
            setManualValue(binderEntry?.value || "");
            setSelectedRarity(binderEntry?.cardType || "standard");
        }, [binderEntry]);

        const handleManualSave = () => {
            onSave(entry.key, { 
                url: manualUrl, 
                fanArtUrl: fanArtUrl, 
                dreamUrl: dreamUrl, 
                idealUrl: idealUrl, 
                name: manualName, 
                owned: binderEntry?.owned || false, 
                value: manualValue, 
                cardType: selectedRarity 
            });
            onBack(); // Automatically return to Dex
        };

        const handleMarketSearch = () => {
            const queryName = manualName || entry.name;
            const queryId = binderEntry?.value || entry.displayId; // Use Value if entered, otherwise ID
            // Safe URL encoding for the search
            const query = `site:pricecharting.com "${queryName}" "${queryId}" pokemon card`;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}&tbm=isch`;
            
            // Open window with specific dimensions to create a "popup" effect
            const w = window.innerWidth * 0.9;
            const h = window.innerHeight * 0.9;
            const left = (window.innerWidth - w) / 2;
            const top = (window.innerHeight - h) / 2;
            
            window.open(searchUrl, 'pricecharting_popup', `width=${w},height=${h},top=${top},left=${left},resizable=yes,scrollbars=yes`);
        };

        const handlePaste = async (setter) => {
            try { const text = await navigator.clipboard.readText(); setter(text); } catch (err) { console.error("Paste failed", err); }
        };

        const isOwned = binderEntry?.owned || false;
        let displayImage = getDefaultImage(entry);
        let showingFanArt = false;
        let showingDream = false;
        let showingIdeal = false;

        if (filterSettings.showRealOnly) { 
            if (manualUrl) displayImage = manualUrl; 
        } else { 
            if (idealUrl && filterSettings.showIdeal) {
                displayImage = idealUrl;
                showingIdeal = true;
            } else if (dreamUrl && filterSettings.showDream) {
                displayImage = dreamUrl;
                showingDream = true;
            } else if (fanArtUrl) { 
                displayImage = fanArtUrl; 
                showingFanArt = true; 
            } else if (manualUrl) {
                displayImage = manualUrl; 
            }
        }

        return (
            <div>
                {showImagePreview && <ImagePreviewModal src={displayImage} onClose={() => setShowImagePreview(false)} />}
                <div className="sticky top-[58px] z-30 bg-slate-900/95 backdrop-blur border-b border-slate-700 py-3 mb-6 -mx-4 px-4 shadow-lg flex flex-wrap gap-2 justify-between items-center">
                    <button onClick={onBack} className="flex items-center gap-2 text-slate-300 hover:text-white transition-colors font-bold"><IconArrowLeft /> Back</button>
                    
                    <div className="flex gap-2">
                        {/* MARKET SEARCH BUTTON */}
                        <button onClick={handleMarketSearch} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors shadow-lg">
                            <IconChart /> Market Price
                        </button>
                        
                        {entry.isCustom && (
                            <button onClick={() => onSwapSlot(entry)} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors shadow-lg">
                                <IconExchange /> Promote
                            </button>
                        )}

                        {/* SAVE BUTTON (MOVED HERE) */}
                        <button 
                            onClick={handleManualSave} 
                            disabled={!manualUrl && !fanArtUrl && !dreamUrl && !idealUrl && selectedRarity === 'standard'}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors shadow-lg ${!manualUrl && !fanArtUrl && !dreamUrl && !idealUrl && selectedRarity === 'standard' ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500 text-white'}`}
                        >
                            <IconSave /> Save
                        </button>
                    </div>
                </div>

                <div className="flex flex-col md:flex-row items-center justify-between mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700 gap-4">
                    <div>
                        <h2 className="text-2xl font-bold flex items-center gap-2">
                            {entry.name.replace(" (Slot)", "")} 
                            <span className={`text-sm px-2 py-1 rounded ${entry.isMega ? 'bg-purple-900 text-purple-200' : entry.isTrainer ? 'bg-indigo-900 text-indigo-200' : 'bg-slate-700 text-slate-400'}`}>{entry.isMega ? 'MEGA' : entry.isTrainer ? 'TRAINER' : '#' + entry.displayId}</span>
                            {entry.isCustom && <span className="text-sm bg-blue-900 text-blue-200 px-2 py-1 rounded">EXTRA SLOT</span>}
                        </h2>
                        <div className="flex items-center gap-2 mt-2">
                            <span className={`text-xs font-bold uppercase tracking-wider ${isOwned ? "text-green-400" : binderEntry ? "text-indigo-400" : "text-slate-500"}`}>Status: {isOwned ? "OWNED" : binderEntry ? "HUNTING" : "EMPTY"}</span>
                            {binderEntry?.value && (
                                <span className="text-xs font-bold uppercase tracking-wider text-green-400 ml-4 border border-green-900/50 bg-green-900/20 px-2 py-0.5 rounded">Value: {binderEntry.value}</span>
                            )}
                        </div>
                    </div>
                    
                    <div className="flex flex-col items-end gap-3">
                        <div className="flex items-center gap-3 bg-slate-900 px-3 py-2 rounded-lg border border-slate-700">
                            <span className="text-xs text-slate-400 font-bold uppercase">Mark as Owned</span>
                            <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0" checked={isOwned} onChange={() => onToggleOwned(entry.key)} />
                                <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer transition-colors duration-300 ${isOwned ? 'bg-green-400' : 'bg-slate-600'}`}></label>
                            </div>
                        </div>

                        <div className="flex gap-2">
                            {!entry.isCustom ? (
                                <button onClick={() => onAddSlot(entry)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded text-xs font-bold text-white transition-colors whitespace-nowrap"><IconPlus /> Slot</button>
                            ) : (
                                <button onClick={() => onRemoveSlot(entry)} className="flex items-center gap-2 bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded text-xs font-bold text-white transition-colors whitespace-nowrap"><IconTrash /> Slot</button>
                            )}
                            
                            {/* UPDATED DELETE CONDITION: Check !isBase instead of ID > 151 */}
                            {!entry.isCustom && !entry.isBase && (
                                <button onClick={() => onDeletePokemon(entry)} className="flex items-center gap-2 bg-red-900/50 hover:bg-red-900 border border-red-800 px-3 py-1.5 rounded text-xs font-bold text-red-200 transition-colors whitespace-nowrap"><IconTrash /> Entry</button>
                            )}
                        </div>
                    </div>
                </div>

                <div className="flex flex-col md:flex-row gap-8">
                    <div className="w-full md:w-1/3 flex flex-col items-center">
                        <div className={`p-2 rounded-xl border relative group cursor-pointer overflow-hidden transition-all duration-300 ${selectedRarity === "MEGA" ? "rarity-mega bg-slate-800" : selectedRarity === "EX" ? "rarity-ex bg-slate-800" : selectedRarity === "GX" ? "rarity-gx bg-slate-800" : selectedRarity === "V" ? "rarity-v bg-slate-800" : selectedRarity === "VMAX" ? "rarity-vmax bg-slate-800" : selectedRarity === "VSTAR" ? "rarity-vstar bg-slate-800" : "border-slate-700 bg-slate-800 shadow-2xl"}`} onClick={() => setShowImagePreview(true)}>
                            <img src={displayImage} className="w-full rounded-lg object-contain transition-transform duration-300 group-hover:scale-[1.02]" style={{ maxHeight: '450px' }} onError={(e) => { e.target.onerror = null; e.target.src = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg"; }} />
                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"><div className="bg-white/20 p-3 rounded-full backdrop-blur-sm text-white"><IconZoom /></div></div>
                            {showingFanArt && <div className="absolute top-4 left-4 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-lg font-bold fan-art-badge z-10"><IconPalette /> FAN ART</div>}
                            {showingDream && <div className="absolute top-4 left-4 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-lg font-bold dream-badge z-10"><IconStar /> DREAM</div>}
                            {showingIdeal && <div className="absolute top-4 left-4 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-lg font-bold ideal-badge z-10"><IconSparkles /> IDEAL</div>}
                            {binderEntry && <div className={`absolute bottom-4 right-4 px-3 py-1 rounded-full text-xs font-bold shadow-lg border z-10 ${isOwned ? 'bg-green-600 text-white border-green-400' : 'bg-indigo-600 text-white border-indigo-400'}`}>{isOwned ? "IN COLLECTION" : "TARGET"}</div>}
                        </div>
                        <p className="text-xs text-slate-500 mt-2 flex items-center gap-1"><IconZoom /> Tap image to enlarge</p>
                    </div>

                    <div className="w-full md:w-2/3">
                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                            <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><IconImage /> Card Details</h3>
                            <div className="space-y-4">
                                <div><label className="block text-sm text-slate-400 mb-1">Card / Set Name</label><input type="text" className="w-full glass-input rounded px-4 py-3 text-white" value={manualName} onChange={(e) => setManualName(e.target.value)} placeholder="e.g. Base Set Charizard, 151 Illustration Rare..." /></div>
                                <div><label className="block text-sm text-slate-400 mb-2">Badge Type (Rarity)</label>
                                    <div className="flex flex-wrap gap-2">
                                        {["standard", "EX", "GX", "V", "VMAX", "VSTAR", "MEGA"].map(r => (
                                            <button key={r} onClick={() => setSelectedRarity(r)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all border ${selectedRarity === r ? `bg-slate-600 border-${r === 'standard' ? 'slate' : 'emerald'}-400 shadow-lg scale-105` : "bg-slate-800 text-slate-500 border-slate-700"}`}>{r.toUpperCase()}</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">TCG Value / Price</label>
                                    <div className="relative"><div className="absolute left-4 top-3.5 text-slate-500"><IconPound /></div><input type="text" className="w-full glass-input rounded pl-10 pr-4 py-3 text-white" value={manualValue} onChange={(e) => setManualValue(e.target.value)} placeholder="e.g. £50.00" /></div>
                                </div>
                                
                                {/* REAL URL */}
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Real Card Image URL</label>
                                    <div className="flex gap-2"><input type="text" className="w-full glass-input rounded px-4 py-3 text-white font-mono text-base" value={manualUrl} onChange={(e) => setManualUrl(e.target.value)} placeholder="Paste REAL card link here..." /><button onClick={() => handlePaste(setManualUrl)} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconClipboard /></button><button onClick={() => setManualUrl('')} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconX /></button></div>
                                </div>
                                
                                {/* IDEAL URL */}
                                <div>
                                    <label className="block text-sm text-cyan-400 mb-1 font-bold flex items-center gap-2"><IconSparkles size={14} /> Ideal / Full Art URL</label>
                                    <div className="flex gap-2"><input type="text" className="w-full glass-input rounded px-4 py-3 text-white font-mono text-base border-cyan-500/30 focus:border-cyan-500" value={idealUrl} onChange={(e) => setIdealUrl(e.target.value)} placeholder="Paste IDEAL / ART link here..." /><button onClick={() => handlePaste(setIdealUrl)} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconClipboard /></button><button onClick={() => setIdealUrl('')} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconX /></button></div>
                                    <p className="text-xs text-slate-500 mt-1">Visually appealing art. Highest priority when enabled.</p>
                                </div>

                                {/* DREAM URL */}
                                <div>
                                    <label className="block text-sm text-amber-400 mb-1 font-bold flex items-center gap-2"><IconStar size={14} /> Dream / Chase Card URL</label>
                                    <div className="flex gap-2"><input type="text" className="w-full glass-input rounded px-4 py-3 text-white font-mono text-base border-amber-500/30 focus:border-amber-500" value={dreamUrl} onChange={(e) => setDreamUrl(e.target.value)} placeholder="Paste DREAM card link here..." /><button onClick={() => handlePaste(setDreamUrl)} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconClipboard /></button><button onClick={() => setDreamUrl('')} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconX /></button></div>
                                </div>

                                {/* FAN ART URL */}
                                <div>
                                    <label className="block text-sm text-pink-400 mb-1 font-bold flex items-center gap-2"><IconPalette size={14} /> Fan Art / Cover URL</label>
                                    <div className="flex gap-2"><input type="text" className="w-full glass-input rounded px-4 py-3 text-white font-mono text-base border-pink-500/30 focus:border-pink-500" value={fanArtUrl} onChange={(e) => setFanArtUrl(e.target.value)} placeholder="Paste FAN ART link here..." /><button onClick={() => handlePaste(setFanArtUrl)} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconClipboard /></button><button onClick={() => setFanArtUrl('')} className="bg-slate-700 hover:bg-slate-600 px-3 rounded text-slate-300"><IconX /></button></div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-6 p-4 border border-slate-700 rounded-xl bg-slate-900/50">
                            <h4 className="font-bold text-sm text-slate-400 mb-2">Useful Image Sources:</h4>
                            <div className="flex gap-2 text-xs">
                                <a href={`https://www.google.com/search?tbm=isch&q=${entry.name}+pokemon+card`} target="_blank" className="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-indigo-300">Google Images</a>
                                <a href={`https://www.tcgplayer.com/search/pokemon/product?productLineName=pokemon&q=${entry.name}&view=grid`} target="_blank" className="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-indigo-300">TCGPlayer</a>
                            </div>
                        </div>
                    </div>
                </div>

                {/* NEW BOTTOM SAVE BUTTON */}
                <button 
                    onClick={handleManualSave} 
                    className={`w-full mt-6 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 text-lg transition-all ${manualUrl || fanArtUrl || dreamUrl || idealUrl || selectedRarity !== 'standard' ? 'bg-indigo-600 hover:bg-indigo-500 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed border border-slate-700'}`} 
                    disabled={!manualUrl && !fanArtUrl && !dreamUrl && !idealUrl && selectedRarity === 'standard'}
                >
                    <IconSave /> Save & Return to Dex
                </button>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>




